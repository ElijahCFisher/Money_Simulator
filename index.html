<HTML>

    <head>
        <script src="https://unpkg.com/function-plot/dist/function-plot.js"></script>
        <script src="https://d3js.org/d3.v6.min.js"></script>
    
        <style>
            #graph {
                width: 100%;
                height: 100%;
                /* background-color: lightgray; */
            }
        </style>
    </head>

    <body>

        <div id="graph"></div>

        <script>

            var accs = {}

            function simulation(funcs, time) {
                for (var i = 0; i < 365*time; i++) {
                    for (var acc in accs) {
                        if (acc == "houses") continue
                        accs[acc].push(accs[acc][accs[acc].length-1]);
                    }
                    for (var func of funcs) {
                        func(i)
                    }
                }
            }

            function salary(money, time) {
                return function salary2(day) {
                    if (day % time == 0) {
                        accs["checking"][accs["checking"].length-1] += money
                        accs["netWorth"][accs["netWorth"].length-1] += money
                    }
                }
            }

            function stocks(interest) {
                return function stocks2(day) {
                    accs["checking"][accs["checking"].length-1] *= Math.E**(interest/365)
                    accs["netWorth"][accs["netWorth"].length-1] += accs["checking"][accs["checking"].length-1]*( 1 - Math.E**(interest/365))
                }
            }

            function buyHouse(price, downPayment, PMI, propertyTax, HOA, interest, years, insurance, rentDowntime) {
                return function buyHouse2(day) {
                    sm = 0
                    for (var house of accs["houses"]) {
                        sm += house[8]
                    }
                    if (accs["checking"][accs["checking"].length-1] > price*downPayment + 4*sm) {
                        var monthlyPayment = (price-price*downPayment)*(interest/12 * (1+interest/12)**(30*12))/((1+interest/12)**(years*12)-1)
                        accs["checking"][accs["checking"].length-1] -= price*downPayment
                        accs["houses"].push([price, downPayment, PMI, propertyTax, HOA, interest, years, insurance, monthlyPayment, price*downPayment, monthlyPayment*1.4, rentDowntime])
                    }
                }
            }

            function payRent(rent) {
                return function payRent2(day) {
                    dy = day%365
                    if (dy == 0 || dy == 31 || dy == 31+28 || dy == 31*2+28 || dy == 31*2+28+30 || dy == 31*3+28+30 || dy == 31*3+28+30*2 || dy == 31*4+28+30*2 || dy == 31*5+28+30*2 || dy == 31*5+28+30*3 || dy == 31*6+28+30*3 || dy == 31*6+28+30*4) {
                        accs["checking"][accs["checking"].length-1] -= rent
                        accs["netWorth"][accs["netWorth"].length-1] -= rent
                    }
                }
            }

            function payInsurance(cost) {
                return function payInsurance2(day) {
                    dy = day%365
                    if (dy == 0 || dy == 31 || dy == 31+28 || dy == 31*2+28 || dy == 31*2+28+30 || dy == 31*3+28+30 || dy == 31*3+28+30*2 || dy == 31*4+28+30*2 || dy == 31*5+28+30*2 || dy == 31*5+28+30*3 || dy == 31*6+28+30*3 || dy == 31*6+28+30*4) {
                        accs["checking"][accs["checking"].length-1] -= cost
                        accs["netWorth"][accs["netWorth"].length-1] -= cost
                    }
                }
            }

            function payBills(cost) {
                return function payInsurance2(day) {
                    dy = day%365
                    if (dy == 0 || dy == 31 || dy == 31+28 || dy == 31*2+28 || dy == 31*2+28+30 || dy == 31*3+28+30 || dy == 31*3+28+30*2 || dy == 31*4+28+30*2 || dy == 31*5+28+30*2 || dy == 31*5+28+30*3 || dy == 31*6+28+30*3 || dy == 31*6+28+30*4) {
                        accs["checking"][accs["checking"].length-1] -= cost
                        accs["netWorth"][accs["netWorth"].length-1] -= cost
                    }
                }
            }

            function buyFood(cost) {
                return function payRent2(day) {
                    accs["checking"][accs["checking"].length-1] -= cost
                    accs["netWorth"][accs["netWorth"].length-1] -= cost
                }
            }

            function repairCar(cost, frequency) {
                return function repairCar(day) {
                    if (day%frequency == 0) {
                        accs["checking"][accs["checking"].length-1] -= cost
                        accs["netWorth"][accs["netWorth"].length-1] -= cost
                    }
                }
            }

            function payMortgage() {
                return function payMortgage2(day) {
                    dy = day%365
                    if (dy == 0 || dy == 31 || dy == 31+28 || dy == 31*2+28 || dy == 31*2+28+30 || dy == 31*3+28+30 || dy == 31*3+28+30*2 || dy == 31*4+28+30*2 || dy == 31*5+28+30*2 || dy == 31*5+28+30*3 || dy == 31*6+28+30*3 || dy == 31*6+28+30*4) {
                        for (var house of accs["houses"]) {
                            accs["checking"][accs["checking"].length-1] -= house[8]
                            // accs["netWorth"][accs["netWorth"].length-1] -= (house[0]-house[9])*house[5]
                            house[9] += house[8] - ((house[0]-house[9])*house[5])
                        }
                    }
                }
            }

            function collectRent() {
                return function collectRent2(day) {
                    // The precision I added here no longer really makes sense, but I'm keeping it for convenience sake
                    for (var house of accs["houses"]) {
                        dy = day%(365 + house[11])
                        if (dy == 0 || dy == 31 || dy == 31+28 || dy == 31*2+28 || dy == 31*2+28+30 || dy == 31*3+28+30 || dy == 31*3+28+30*2 || dy == 31*4+28+30*2 || dy == 31*5+28+30*2 || dy == 31*5+28+30*3 || dy == 31*6+28+30*3 || dy == 31*6+28+30*4) {
                            accs["checking"][accs["checking"].length-1] += house[10]
                            accs["netWorth"][accs["netWorth"].length-1] += house[10]
                        }
                    }
                }
            }

            function makeScenario(key, inpAccs) {
                return function (scope) {
                    // scope.x = {lo: Number, hi: number}
                    // simulate a line e.g. y = x
                    // return (salary - monthlyPayment)*(scope.x-2021)
                    // return monthlyPayment*(2.7)**((scope.x-2021) * interest)
                    return inpAccs[key][Math.floor((scope.x-2021)*365)]
                }
            }
            accs = {"checking": [60000], "houses": [], "netWorth":[60000]}
            sim = simulation([
                salary(2000, 14),
                collectRent(),
                payMortgage(),
                payRent(1200),
                buyFood(7),
                payInsurance(200),
                payBills(200),
                repairCar(1000,364/2),
                stocks(.06),
                buyHouse(200000, .1, 100, .0057, 100, .04125, 30, 1995, 90),
            ], 15)

            sc1 = makeScenario("checking", accs)
            sc2 = makeScenario("netWorth", accs)

            // accs = {"checking": [60000], "houses": [], "netWorth":[60000]}
            // sim = simulation([
            //     salary(2000, 14),
            //     stocks(.06),
            //     buyHouse(200000, .1, 100, .0057, 100, .04125, 30, 1995, 90),
            //     collectRent(),
            //     payMortgage(),
            //     // payRent(1200),
            //     // buyFood(7),
            //     // payInsurance(200),
            //     // payBills(200),
            //     // repairCar(1000,364/2)
            // ], 10)

            // sc3 = makeScenario("checking", accs)
            // sc4 = makeScenario("netWorth", accs)


            var plot = functionPlot({
                width: document.getElementById('graph').clientWidth,
                height: document.getElementById('graph').clientHeight,
                target: '#graph',
                yAxis: {domain: [-100000, 1000000]},
                xAxis: {domain: [2021, 2035]},
                xLabel: 'time (year)',
                yLabel: 'money (dollars)',
                grid: true,
                tip: {
                    xLine: true,    // dashed line parallel to y = 0
                    yLine: true,    // dashed line parallel to x = 0
                    renderer: function (x, y, index) {
                        // the returning value will be shown in the tip
                        return `[${23+Math.floor(x-2021)}] ${xToDateStr(x)}: $${d3.format(",")(Math.round(y))}`;
                    }
                },
                data: [
                    {
                        graphType: 'polyline',
                        fn: sc1
                    },
                    {
                        graphType: 'polyline',
                        fn: sc2
                    },
                    // {
                    //     graphType: 'polyline',
                    //     fn: sc3
                    // },
                    // {
                    //     graphType: 'polyline',
                    //     fn: sc4
                    // }
                    // {
                    //     // force the use of builtIn math
                    //     graphType: 'polyline',
                    //     fn: function (scope) {
                    //         // scope.x = Number
                    //         var x = scope.x - 2021
                    //         return 20000*x * x
                    // }
                    // }, {
                    //     // uses interval arithmetic by default
                    //     fn: function (scope) {
                    //         // scope.x = {lo: Number, hi: number}
                    //         // simulate a line e.g. y = x
                    //         return {
                    //             lo: 10000*(2.7)**((scope.x.lo-2021) * .11),
                    //             hi: 10000*(2.7)**((scope.x.hi-2021) * .12)
                    //         }
                    //     }
                    // }
                ]
            })

            // plot.meta.xAxis.tickFormat(t => t)
            function decimalDateToJsDate(time) { // thanks https://stackoverflow.com/a/29400701
                var year = Math.floor(time);
                var thisYear = new Date(year, 0, 1);
                var nextYear = new Date(year + 1, 0, 1);
                var millisecondsInYear = nextYear.getTime() - thisYear.getTime();
                var deltaTime = Math.ceil((time - year) * millisecondsInYear);
                thisYear.setMilliseconds(deltaTime);
                return thisYear;
            }
            function xToDateStr(e) { return d3.timeFormat("%b %d, %Y")(decimalDateToJsDate(e)); } // todo eventually do better axis at different resolutions with https://stackoverflow.com/a/35050898
            plot.meta.xAxis.tickFormat( x => `[${23+Math.floor(x-2021)}] ${xToDateStr(x)}` );
            plot.draw();

            // $('#recipes').load('partials/recipes.html')
            // $('#examples').load('partials/examples.html', function () {
            //     $(document).trigger('markupLoaded')
            //     $('pre code').each(function (i, block) {
            //         hljs.highlightBlock(block)
            //     })

            //     $('#p-slider').on('change', function () {
            //         var value = +this.value;
            //         $('#p-slider-value').html(value)
            //     })
            // })
        </script>
    </body>

</HTML>